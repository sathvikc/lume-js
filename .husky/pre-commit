#!/bin/sh
set -e

echo "ğŸ§¼ Auto-fixing trailing whitespace on staged files..."
# Get staged files (added/modified) and trim trailing whitespace in-place
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | tr '\n' ' ')
if [ -n "$STAGED_FILES" ]; then
  for file in $STAGED_FILES; do
    # Only process text files
    if git ls-files --eol -- "$file" | grep -vE 'wcrlf|binary' > /dev/null; then
      # Strip trailing spaces and tabs at end of lines
      sed -E -i '' 's/[ \t]+$//' "$file" 2>/dev/null || sed -E -i 's/[ \t]+$//' "$file"
      # Ensure file ends with a single newline
      perl -0777 -pe 's/\s*$/\n/' "$file" > "$file".tmp && mv "$file".tmp "$file" 2>/dev/null || true
      # Re-stage file after modifications
      git add "$file"
    fi
  done
fi

echo "ğŸ” Checking for whitespace errors after auto-fix..."
git diff --check --cached || {
  echo "âŒ FAIL: Whitespace errors remain. Please fix and retry."
  exit 1
}

echo "ğŸ§ª Running tests..."
npm test || {
  echo "âŒ FAIL: Tests failed. Fix before committing."
  exit 1
}

echo "ğŸ“¦ Checking bundle size..."
npm run size || {
  echo "âŒ FAIL: Bundle size check failed. Gzipped size must be <2KB."
  exit 1
}

echo "âœ… All checks passed!"
